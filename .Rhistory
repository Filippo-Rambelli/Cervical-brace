soft_def$percentage<-soft_def$amount/soft_def$`sum(amount)`
ggplot(soft_def[1:15,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
soft_def<-left_join(soft_tib,total_soft)%>%arrange(surgery)
soft_def$percentage<-soft_def$amount/soft_def$`sum(amount)`
ggplot(soft_def[1:15,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
df<-as_tibble(data.frame(surge,dura))
colnames(df)<-c("surgery","duration")
soft_def<-left_join(df,soft)
soft_def$amount[is.na(soft_def$amount)]<-0
soft_tib<-as_tibble(soft_def)
total_soft<-group_by(soft_def,surgery)%>%dplyr::summarize(sum(amount))
soft_def<-left_join(soft_tib,total_soft)%>%arrange(surgery)
soft_def$percentage<-soft_def$amount/soft_def$`sum(amount)`
ggplot(soft_def[1:15,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
soft_full<-left_join(df,soft)
soft_full$amount[is.na(soft_full$amount)]<-0
soft_tib<-as_tibble(soft_full)
total_soft<-group_by(soft_full,surgery)%>%dplyr::summarize(sum(amount))
soft_def<-left_join(soft_tib,total_soft)%>%arrange(surgery)
soft_def$percentage<-soft_def$amount/soft_def$`sum(amount)`
ggplot(soft_def[1:15,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
soft_def<-left_join(soft_full,total_soft)%>%arrange(surgery)
soft_def$percentage<-soft_def$amount/soft_def$`sum(amount)`
ggplot(soft_def[1:15,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
soft_def$surgery = str_wrap(soft_def$surgery, width = 15)
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
rigid<-duration_df[(duration_df$collar=="rigid"),]
rigid_full<-left_join(tibb,rigid)
tibb<-as_tibble(data.frame(surge,dura))
rigid_full<-left_join(tibb,rigid)
colnames(tibb)<-c("surgery","duration")
rigid_full<-left_join(tibb,rigid)
rigid_full$amount[is.na(rigid_full$amount)]<-0
total_rigid<-group_by(rigid_full,surgery)%>%dplyr::summarize(sum(amount))
rigid_def<-left_join(rigid_full,total_rigid)%>%arrange(surgery)
rigid_def$percentage<-rigid_def$amount/rigid_def$`sum(amount)`
ggplot(rigid_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
ggplot(rigid_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
rigid_def$surgery = str_wrap(rigid_def$surgery, width = 15)
ggplot(rigid_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
ggplot(rigid_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.6), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 5, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 5.3, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(rigid_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
ggplot(rigid_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
ggplot(soft_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
rm(list=ls())
library("plotrix")
library("ggplot2")
library("tidyverse")
library("naniar")
library("visdat")
library("ggplot2")
library("corrplot")
library("gridExtra")
library("grid")
library("readr")
library(dplyr)
library(tidyr)
library(readxl)
Cervical_Brace_use_in_Post_Operative_Cervical_Spine_Surgery_TOT <- read_excel("Cervical Brace use in Post-Operative Cervical Spine Surgery TOT.xlsx")
View(Cervical_Brace_use_in_Post_Operative_Cervical_Spine_Surgery_TOT)
data<-as.data.frame(Cervical_Brace_use_in_Post_Operative_Cervical_Spine_Surgery_TOT)
data<-data[-c(11,54),]#!
data<-data[complete.cases(data$Specializzazione),]
data$ID[1:61]<-seq(1,61,1)
rownames(data)<-seq(1,61,1)
#missing value imputation (information from internet)
data$`Tipologia di ospedale`[53]<-"Altro"
#missing value imputation (taken from an other observation that refers to the same hospital)
data$`Bacino di utenza afferente all'Ospedale`[41]<-"100.000-500.000"
#converting variables into factor
data$`Tipologia di ospedale`<-as.factor(data$`Tipologia di ospedale`)
data$`Ospedale di attività`<-as.factor(data$`Ospedale di attività`)
data$`Principale patologia trattata`<-as.factor(data$`Principale patologia trattata`)
data$`Bacino di utenza afferente all'Ospedale`<-as.factor(data$`Bacino di utenza afferente all'Ospedale`)
data$Specializzazione<-as.factor(data$Specializzazione)
#fixing wrong answers in the year of birth variable
data$`Anno di nascita`
lung<-vector()
for(i in 1:dim(data)[1]){
lung[i]<-nchar(data$`Anno di nascita`[i])
}
wrong_date<-which(lung!=4)
substrRight <- function(x, n){
substr(x, nchar(x)-n+1, nchar(x))
}
data$`Anno di nascita`[wrong_date]<-as.numeric(substrRight(data$`Anno di nascita`[wrong_date],4))
data$`Anno di nascita`<-as.numeric(data$`Anno di nascita`)
#fixing wrong answers in the year of experience variable
data$`Anni di esperienza in chirurgia spinale`<-as.numeric(substring(data$`Anni di esperienza in chirurgia spinale`,first=1,last=2))
#adjusting other values
data$`Regione di attività`<-tolower(data$`Regione di attività`)
unique(data$`Regione di attività`)
data$`Regione di attività`[data$`Regione di attività`=="campani"]<-"campania"
data$`Regione di attività`[data$`Regione di attività`=="emilia"]<-"emilia romagna"
data$`Regione di attività`[data$`Regione di attività`=="sicilia calabria"]<-"sicilia"
data$`Ospedale di attività`[data$`Ospedale di attività`=="Convezionato"]<-"Convenzionato"
data$`Su un totale ipotetico di 10 interventi, quanti sono svolti con approccio posteriore?`[is.na(data$`Su un totale ipotetico di 10 interventi, quanti sono svolti con approccio posteriore?`)]<-0
names <- c(14:104)
data[,names]<-lapply(data[,names],tolower)
data[,names] <- lapply(data[,names] , factor)
data$`Bacino di utenza afferente all'Ospedale`[data$`Bacino di utenza afferente all'Ospedale` ==">1000000"]<-">1.000.000"
data$`Bacino di utenza afferente all'Ospedale`[data$`Bacino di utenza afferente all'Ospedale` =="500.000-1000.000"]<-"500.000-1.000.000"
data$`Bacino di utenza afferente all'Ospedale`<-droplevels(data$`Bacino di utenza afferente all'Ospedale`)
data$`Ospedale di attività`<-droplevels(data$`Ospedale di attività`)
data$`Numero di interventi cervicali annui`<-as.numeric(parse_number(data$`Numero di interventi cervicali annui`))
missing<-which(is.na(data$`Numero di interventi cervicali annui`))
tib<-as_tibble(data)
gru<-group_by(tib,`Bacino di utenza afferente all'Ospedale`)
dplyr::summarize(gru,n=n(),aver=mean(`Numero di interventi cervicali annui`,na.rm=T))
data[missing,c(9:10)]
data$`Numero di interventi cervicali annui`[c(6,43,53)]<-63
data$`Numero di interventi cervicali annui`[c(18,28)]<-73
prop.table(table(data$Specializzazione))
prop.table(table(data$`Tipologia di ospedale`))
prop.table(table(data$`Ospedale di attività`))
prop.table(table(data$`Bacino di utenza afferente all'Ospedale`))
prop.table(table(data$`Principale patologia trattata`))
colnames(data)[8]<-"Zona"
data$Zona
data$Zona[c(4,5,8,10,12,13,16,17,18,20,23,24,25,27,29,34,37,41,44,45,46,47,50,51,53,55,56,57,58,59,60)]<-"Nord"
data$Zona[c(3,7,11,30,32,35,36,49,52,54,61)]<-"Centro"
data$Zona[c(1,2,6,9,14,15,19,21,22,26,28,31,33,38,39,40,42,43,48)]<-"Sud e isole"
data$Zona<-as.factor(data$Zona)
prop.table(table(data$Zona))
p1 <- ggplot(data, aes_string(data$`Anni di esperienza in chirurgia spinale`)) +
geom_boxplot(fill ="#FF6666",outlier.colour = "blue", outlier.shape = 1) + coord_flip()+
labs(x="Experience in cervical spine surgery")
p2 <- ggplot(data , aes_string(data$`Anno di nascita`)) +
geom_boxplot(fill="dodgerblue",outlier.colour = "blue", outlier.shape = 1) + coord_flip()+
labs(x="Year of birth")
p3 <- ggplot(data, aes_string(data$`Numero di interventi cervicali annui`)) +
geom_boxplot(fill="green",outlier.colour = "blue", outlier.shape = 1) + coord_flip()+
labs(x="Cervical surgeries per year")
boxes <- list(p1,p2,p3)
do.call(grid.arrange, c(boxes, nrow = 1))
gg1 <- ggplot(data, aes_string(x=data$`Anni di esperienza in chirurgia spinale`)) +
geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth = 10)+
geom_density(alpha=.4, fill="#FF6666")+
labs(x="Experience in cervical spine surgery")
gg2 <- ggplot(data, aes_string(x=data$`Anno di nascita`)) +
geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth = 10)+
geom_density(alpha=.4, fill="dodgerblue")+
labs(x="Year of birth")
gg3 <- ggplot(data, aes_string(x=data$`Numero di interventi cervicali annui`)) +
geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth = 20)+
geom_density(alpha=.4, fill="green")+
labs(x="Cervical surgeries per year")
hists <- list(gg1,gg2,gg3)
do.call(grid.arrange, c(hists, nrow = 1))
summary(data[,94:98])[2,]
c(24,53,39,26,20)/sum(c(24,53,39,26,20))
summary(data[,99:101])[2,]
c(23,25,50)/sum(c(23,25,50))
summary(data[,102:104])[2,]
c(23,7,7)/sum(c(23,7,7))
data_dur<-data[,c(14,21,22,29,30,37,38,45,46,53,54,61,62,69,70,77,78,85,86,93)]
data_dur<-data[,c(14,21,22,29,30,37,38,45,46,53,54,61,62,69,70,77,78,85,86,93)]
summary(data_dur)
levels(data_dur[,1])<-c("morbido","nessun collare","rigido")
dur<-as_tibble(data_dur)
colnames(dur)[c(seq(1,19,2))]<-c("1 level DAA without plate","2 level DAA without plate","1 level DAA with plate",
"DAA of more than 1 level with plate","Cervical laminectomy without stabilization",
"Cervical laminectomy with posterior stabilization","Open door laminoplasty" ,
"C1-C2 Stabilization" ,"Occipito-cervical fixation" , "Circumferential fixation")
colnames(dur)[c(seq(2,20,2))]<-sprintf("duration%s",seq(1:10))
#using gather function to get the long version of the dataset
dur_long<-tidyr::gather(dur,"1 level DAA without plate","2 level DAA without plate","1 level DAA with plate",
"DAA of more than 1 level with plate","Cervical laminectomy without stabilization",
"Cervical laminectomy with posterior stabilization","Open door laminoplasty" ,
"C1-C2 Stabilization" ,"Occipito-cervical fixation" , "Circumferential fixation",key="intervento",value="collare")
#some adjustments
levels(dur_long$duration1)<-c(levels(dur_long$duration1),"> 4 mesi")
dur_long$duration1[62:122]<-dur_long$duration2[62:122]
dur_long$duration1[123:183]<-dur_long$duration3[123:183]
dur_long$duration1[184:244]<-dur_long$duration4[184:244]
dur_long$duration1[245:305]<-dur_long$duration5[245:305]
dur_long$duration1[306:366]<-dur_long$duration6[306:366]
dur_long$duration1[367:427]<-dur_long$duration7[367:427]
dur_long$duration1[428:488]<-dur_long$duration8[428:488]
dur_long$duration1[489:549]<-dur_long$duration9[489:549]
dur_long$duration1[550:610]<-dur_long$duration10[550:610]
duration<-select(dur_long,-num_range("duration", 2:10))%>%filter(collare!="nessun collare")%>%group_by(intervento,collare,duration1)%>%dplyr::summarise(n=n())#%>%filter(duration1!="NA")
duration<-select(dur_long,-num_range("duration", 2:10))%>%
filter(collare!="nessun collare")%>%
group_by(intervento,collare,duration1)%>%
dplyr::summarise(n=n())%>%filter(duration1!="NA")
#some transformations and translations
duration_df<-as.data.frame(duration)
colnames(duration_df)<-c("surgery","collar","duration","amount")
duration_df$collar<-as.factor(duration_df$collar)
levels(duration_df$collar)<-c("soft","rigid")
duration_df$duration<-as.factor(duration_df$duration)
levels(duration_df$duration)<-c("< 4 weeks", "2-4 months", "4-8 weeks"," > 4 months")
#we can explore the df to analyse the prescription after a specific surgery
duration_df
#for instance
duration_df[(duration_df$collar=="soft")&(duration_df$surgery=="1 level DAA without plate"),]
#soft
soft<-duration_df[(duration_df$collar=="soft"),]
#we can explore the df to analyse the prescription after a specific surgery
duration_df
#soft
soft<-duration_df[(duration_df$collar=="soft"),]
#creating a tibble with all the possible combination of surgery and duration of prescriptions
surge<-c(rep("1 level DAA without plate" , 4) ,
rep("2 level DAA without plate" , 4) ,
rep("1 level DAA with plate" , 4) ,
rep("DAA of more than 1 level with plate" , 4),
rep("Cervical laminectomy without stabilization" , 4),
rep("Cervical laminectomy with posterior stabilization" , 4),
rep("Open door laminoplasty" , 4), rep("C1-C2 Stabilization" , 4),
rep("Occipito-cervical fixation" , 4), rep("Circumferential fixation" , 4) )
dura<-factor(rep(c("< 4 weeks","4-8 weeks","2-4 months"," > 4 months"),10),
levels=c("< 4 weeks","4-8 weeks","2-4 months"," > 4 months"))
tibb<-as_tibble(data.frame(surge,dura))
colnames(tibb)<-c("surgery","duration")
#joining it with the real dataset
soft_full<-left_join(tibb,soft)
soft_full$amount[is.na(soft_full$amount)]<-0
total_soft<-group_by(soft_full,surgery)%>%dplyr::summarize(sum(amount))
soft_def<-left_join(soft_full,total_soft)%>%arrange(surgery)
soft_def$percentage<-soft_def$amount/soft_def$`sum(amount)`
soft_def$surgery = str_wrap(soft_def$surgery, width = 15)
ggplot(soft_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
ggplot(soft_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Soft brace prescriptions'duration",y="")+scale_fill_brewer(palette="BuPu")+theme_bw()
#rigid
rigid<-duration_df[(duration_df$collar=="rigid"),]
rigid_full<-left_join(tibb,rigid)
rigid_full$amount[is.na(rigid_full$amount)]<-0
total_rigid<-group_by(rigid_full,surgery)%>%dplyr::summarize(sum(amount))
rigid_def<-left_join(rigid_full,total_rigid)%>%arrange(surgery)
rigid_def$percentage<-rigid_def$amount/rigid_def$`sum(amount)`
rigid_def$surgery = str_wrap(rigid_def$surgery, width = 15)
ggplot(rigid_def[1:20,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
ggplot(rigid_def[21:40,],aes(x=percentage,y=surgery,fill=duration))+geom_col(position = position_dodge2(preserve = "single"))+
geom_text(aes(label = paste0(sprintf("%1.1f", percentage*100),"%")), position = position_dodge(0.9), hjust = 1, size = 4.5, color = "black")+
labs(title="Rigid brace prescriptions'duration",y="")+scale_fill_brewer(palette="YlOrRd")+theme_bw()
data2<-read.csv("dati4_2.csv",sep=",")
data2[is.na(data2[,11]),11]<-"no"
data2[is.na(data2[,12]),12]<-"no"
data2[is.na(data2[,13]),13]<-"no"
data2[is.na(data2[,14]),14]<-"no"
data2[is.na(data2[,15]),15]<-"no"
data2[is.na(data2[,16]),16]<-"no"
data2[which(data2[,11]=="si, no"),11]<-"si"
data2[is.na(data2[,17]),17]<-"no"
data2[is.na(data2[,18]),18]<-"no"
data2[is.na(data2[,19]),19]<-"no"
data2[is.na(data2[,20]),20]<-"no"
data2[is.na(data2[,21]),21]<-"no"
data2[is.na(data2[,22]),22]<-"no"
data2[is.na(data2[,23]),23]<-"no"
data2[is.na(data2[,24]),24]<-"no"
data2[is.na(data2[,25]),25]<-"no"
data2[is.na(data2[,26]),26]<-"no"
data2[is.na(data2[,27]),27]<-"no"
tofactor<-c(2,3,6:8,10:29)
data2[,tofactor]<-lapply(data2[,tofactor],factor)
data2[,11]<-droplevels(data2[,11])
data2$Bacino.di.utenza.afferente.all.Ospedale<-factor(data2$Bacino.di.utenza.afferente.all.Ospedale,
levels=c("<100.000","100.000-500.000","500.000-1.000.000",">1.000.000"))
summary(data2$Collare)
tib2<-as_tibble(data2)
dplyr::group_by(tib2,Intervento)%>%dplyr::summarize(n=n())
dplyr::group_by(tib2,Intervento)%>%dplyr::summarize(n=n())
surg<-dplyr::group_by(tib2,Intervento,Collare)%>%dplyr::summarize(n=n())
colnames(surg)<-c("Surgery","Collar","amount")
colnames(surg)<-c("Surgery","Collar","amount")
surg$Surgery<-c(rep("1 level DAA with plate" , 3) ,
rep("1 level DAA without plate" , 3) ,
rep("2 level DAA without plate" , 3) ,
rep("DAA of more than 1 level with plate" , 3),
rep("Circumferential fixation" , 3),rep("Occipito-cervical fixation" , 3),
rep("Cervical laminectomy with posterior stabilization" , 3),
rep("Cervical laminectomy without stabilization" , 3),
rep("Open door laminoplasty" , 3), rep("C1-C2 Stabilization" , 3) )
levels(surg$Collar)<-c("soft","no collar","rigid")
#we can explore the amount of prescription for each collar
spread(surg,Collar,amount)
#compute percentages to create a proper plot
prescription<-spread(surg,Collar,amount)
prescription_df<-as.data.frame(prescription)
for(i in 1:10){
prescription_df[i,2:4]<-prescription_df[i,2:4]/sum(prescription_df[i,2:4])
}
prescription_tib<-as_tibble(prescription_df)
prescription_long<-gather(prescription_tib,soft,'no collar',rigid,key=collar,value=amount)%>%arrange(Surgery)
prescription_long$Surgery = str_wrap(prescription_long$Surgery, width = 15)
ggplot(prescription_long[1:15,],aes(y=Surgery,x=amount,fill=collar))+geom_col(position = position_dodge())+
geom_text(aes(label = paste0(sprintf("%1.1f", amount*100),"%")), position = position_dodge(0.9), hjust = 1, size = 5.3, color = "black")+
labs(y="",title="Cervical brace prescription",x="percentage")+scale_fill_brewer(palette="Dark2")+
theme_bw()
ggplot(prescription_long[16:30,],aes(y=Surgery,x=amount,fill=collar))+geom_col(position = position_dodge())+
geom_text(aes(label = paste0(sprintf("%1.1f", amount*100),"%")), position = position_dodge(0.9), hjust = 1, size = 5.3, color = "black")+
labs(y="",title="Cervical brace prescription",x="percentage")+scale_fill_brewer(palette="Dark2")+
theme_bw()
# create dummy variables for logistic regression
data_du<-data2[,-c(22:27)]
data_du<-dummy_cols(data_du,select_columns = c("Specializzazione","Tipologia.di.ospedale","Ospedale.di.attività","Regione","Bacino.di.utenza.afferente.all.Ospedale",
"Principale.patologia.trattata","Intervento"))
data_du<-dummy_cols(data_du,select_columns = c("Specializzazione","Tipologia.di.ospedale","Ospedale.di.attività","Regione","Bacino.di.utenza.afferente.all.Ospedale",
"Principale.patologia.trattata","Intervento"))
#removing original variables
data_du<-data_du[,-c(2,3,6,7,8,10,22)]
#creating proper factors
data_du[,17:42] <- lapply(data_du[,17:42] , factor)
for(i in 5:15){
data_du[i]<-as.factor(as.numeric(data_du[,i])-1)
}
colnames(data_du)<-c("ID","Age","Experience in cervical surgery","log(surgeries per year)","Post-operative pain",
"Earlier mobilization of the patient","Arthrodesis ratio increase","Patient ’expects’ a brace",
"Legal and medical protection","Post surgical kyphosis rate reduction","Literature","Personal experience",
"Colleagues’ teaching ","Local customs","Tutela medico legale ","Collar","Neurosurgery","Orthopaedic",
"'other' hospital","Polyclinic hospital","University hospital","Affiliate hospital",
"Public hospital","Central Italy","Northern Italy","Southern Italy and islands","Catchment area <100.000",
"Catchment area 100.000-500.000","Catchment area 500.000-1.000.000","Catchment area >1.000.000","Elective pathology","Traumatic pathology",
"1 level discectomy and anterior arthrodesis with plate surgery"," 1 level discectomy and anterior arthrodesis without plate surgery",
"2 level discectomy and anterior arthrodesis without plate surgery"," 1 or more level discectomy and anterior arthrodesis with plate surgery",
"Circumferential fixation","Occipito-cervical fixation",
"Cervical laminectomy with posterior stabilization","Cervical laminectomy without stabilization",
"Open door laminoplasty","C1-C2 Stabilization")
levels(data_du$Collar)<-c("soft","no collar","rigid")
data_sr<-data_du[data_du$Collar=="soft"|data_du$Collar=="rigid",]
data_sr$Collar<-droplevels(data_sr$Collar)
data_sr$Collar<-relevel(data_sr$Collar,ref="soft")
summary(data_sr$Collar)
data_sr[,3]<-(data_sr[,3]-mean(data_sr[,3]))/sqrt(var(data_sr[,3]))
data_sr[,4]<-(data_sr[,4]-mean(data_sr[,4]))/sqrt(var(data_sr[,4]))
#full model estimation
mod_sr<-glm(Collar~.-ID - Age-Neurosurgery-`Catchment area 100.000-500.000`
-`'other' hospital`-`Northern Italy`-`Public hospital`
-`Elective pathology`-`1 level discectomy and anterior arthrodesis with plate surgery`
,family="binomial",data=data_sr)
summary(mod_sr)
exp(coef(mod_sr))
AIC(mod_sr)#456.2
#stepwise selection
mod_sr2<-stepAIC(mod_sr, direction = "both", trace = FALSE)
texreg(mod_sr2,single.row = T,scalebox = 0.7,stars = c(0.01, 0.05, 0.1))
summary(mod_sr2)
summ(mod_sr2,exp=T)
AIC(mod_sr2)#439.2
#variance inflation factor
vif(mod_sr2)#ok
#Hosmer-Lemwshow test
HLtest(mod_sr2,g=24)#ok
#Pearson's statistics gof test
rp<-residuals(mod_sr2,type="pearson")
pchisq(sum(rp^2),420,lower.tail = F)#ok
plot(mod_sr2,which=4)
influenceIndexPlot(mod_sr2)
#397 has high influence on the model
data_du["397",]
outlierTest(mod_sr2)
rw<-rstudent(mod_sr2)
eta<-predict(mod_sr2,data_sr)
gg<-data.frame(eta,rw,data_sr$Collar)
levels(gg$data_sr.Collar)<-c("indianred3", "cornflowerblue")
ggplot(gg,aes(x=eta,y=rw))+geom_point(col=(gg$data_sr.Collar))+geom_smooth(col="blueviolet")+theme_bw()+
labs(y="Studentized residuals",
x="Linear predictor")+ theme(
axis.title.x = element_text(color = "black", size = 16, face = "bold"),
axis.title.y = element_text(color = "black", size = 16, face = "bold"))
data_sn<-data_du[data_du$Collar=="soft"|data_du$Collar=="no collar",]
data_sn$Collar<-relevel(data_sn$Collar,ref="soft")
data_sn$Collar<-droplevels(data_sn$Collar)
summary(data_sn$Collar)
#excluding predictors that create perfect separation
data_sn<-data_sn[,-c(5:10)]
#standardize quantitative predictors
data_sn[,3]<-(data_sn[,3]-mean(data_sn[,3]))/sqrt(var(data_sn[,3]))
data_sn[,4]<-(data_sn[,4]-mean(data_sn[,4]))/sqrt(var(data_sn[,4]))
#full model estimation
mod_sn<-glm(Collar~.-ID - Age-Neurosurgery-`Catchment area 100.000-500.000`
-`'other' hospital`-`Northern Italy`-`Public hospital`
-`Elective pathology`-`1 level discectomy and anterior arthrodesis with plate surgery`
,family="binomial",data=data_sn)
summary(mod_sn)
exp(coef(mod_sn))
AIC(mod_sn)#316.2
#stepwise selection
mod_sn2<-stepAIC(mod_sn,direction="both")
summary(mod_sn2)
summ(mod_sn2,exp=T)
AIC(mod_sn2)#303.4
#variance inflation factor
vif(mod_sn2)#ok
#hosmer-lemeshow test
HLtest(mod_sn2,g=17)#H0 rejected
#Pearson's statistics gof test
rp2<-residuals(mod_sn2,type="pearson")
pchisq(sum(rp2^2),266,lower.tail = F)#H0 rejected
sort(abs(rstudent(mod_sn2)))
#3 observation with high influence on the model
data_du[c("135","309","279"),]
rw2<-rstudent(mod_sn2)
eta2<-predict(mod_sn2)
gg2<-data.frame(rw2,eta2,data_sn$Collar)
levels(gg2$data_sn.Collar)<-c("green3", "orangered")
ggplot(gg2,aes(x=eta2,y=rw2))+geom_point(col=gg2$data_sn.Collar)+theme_bw()+
geom_smooth(col="blue4")+labs(y="Studentized residuals",x="Linear predictor")+ theme(
axis.title.x = element_text(color = "black", size = 16, face = "bold"),
axis.title.y = element_text(color = "black", size = 16, face = "bold"))
outlierTest(mod_sn2)
data_sn<-data_du[data_du$Collar=="soft"|data_du$Collar=="no collar",]
data_sn$Collar<-relevel(data_sn$Collar,ref="soft")
data_sn$Collar<-droplevels(data_sn$Collar)
data_sn<-data_sn[,-c(5:10)]
row.names.remove <- c("135","309","279")
data_sn[c("135","309","279"),]
data_sn<-data_sn[!(row.names(data_sn) %in% row.names.remove), ]
data_sn[,3]<-(data_sn[,3]-mean(data_sn[,3]))/sqrt(var(data_sn[,3]))
data_sn[,4]<-(data_sn[,4]-mean(data_sn[,4]))/sqrt(var(data_sn[,4]))
#full model estimation
mod_sn<-glm(Collar~.-ID - Age-Neurosurgery-`Catchment area 100.000-500.000`
-`'other' hospital`-`Northern Italy`-`Public hospital`
-`Elective pathology`-`1 level discectomy and anterior arthrodesis with plate surgery`
,family="binomial",data=data_sn)
summary(mod_sn)
AIC(mod_sn)#283.6
#stepwise selection
mod_sn2<-stepAIC(mod_sn,direction="both")
summary(mod_sn2)
summ(mod_sn2,exp=T)
texreg(mod_sn2,single.row = T,fontsize="tiny",stars = c(0.01, 0.05, 0.1))
AIC(mod_sn2)#270.9
#hosmer lemeshow test
HLtest(mod_sn2,g=19)#ok
#Pearson's statistics gof test
rp3<-residuals(mod_sn2,type="pearson")
pchisq(sum(rp3^2),261,lower.tail = F)#ok
eta3<-predict(mod_sn2)
rw3<-rstudent(mod_sn2)
gg3<-data.frame(rw3,eta3,data_sn$Collar)
levels(gg3$data_sn.Collar)<-c("green3", "orangered")
ggplot(gg3,aes(x=eta3,y=rw3))+geom_point(col=gg3$data_sn.Collar)+theme_bw()+
geom_smooth(col="blue4")+labs(y="Studentized residuals",x="Linear predictor")+ theme(
axis.title.x = element_text(color = "black", size = 16, face = "bold"),
axis.title.y = element_text(color = "black", size = 16, face = "bold"))
outlierTest(mod_sn2)
setwd("C:/Users/Utente/Desktop/git")
library(readxl)
data <- read_excel("data.xlsx")
View(data)
data<-as.data.frame(data)
library(readxl)
Cervical_brace_1 <- read_excel("Cervical_brace_1.xlsx")
View(Cervical_brace_1)
data<-as.data.frame(Cervical_brace_1)
data2<-read.csv("Cervical_brace_2.csv",sep=",")
